# 武器升级系统 - 修改摘要

## 📋 修改概览

本次修改为项目添加了完整的武器升级系统，支持武器的添加、升级和属性管理。

## 🆕 新增文件

### 1. WeaponUpgradeManager.cs
**路径**: `Assets/Scripts/Battle/WeaponUpgradeManager.cs`
**功能**: 武器升级的核心管理器
**主要方法**:
- `AddWeapon()` - 添加新武器
- `UpgradeWeapon()` - 升级现有武器
- `GetWeaponLevel()` - 查询武器等级
- `CanUpgradeWeapon()` - 检查是否可升级
- `TryGetWeaponStats()` - 获取武器运行时属性

### 2. WeaponRuntimeStatsComponent.cs
**路径**: `Assets/Scripts/Game/ECS/WeaponRuntimeStatsComponent.cs`
**功能**: 武器运行时属性组件
**特性**:
- 存储每个武器的详细属性
- 支持基础属性和升级修改
- 提供计算最终属性的方法
- 分别支持投射物和环绕武器类型

### 3. 武器升级系统文档.md
**路径**: `Assets/Scripts/Battle/武器升级系统文档.md`
**内容**: 完整的系统使用文档和集成指南

## 🔄 修改文件

### 1. UpgradeApplyService.cs
**修改内容**:
- 添加了 `Initialize()` 方法用于注入 WeaponUpgradeManager
- 重写了 `ApplyWeapon()` 方法，支持添加和升级武器
- 添加了对 PlayerUpgradeState 的更新
- 改进了日志输出

**关键变化**:
```csharp
// 旧代码
Debug.Log($"[UpgradeApplyService] 添加武器 - {weaponId}");

// 新代码
if (currentLevel == 0) {
    weaponUpgradeManager.AddWeapon(world, player, weaponId);
    upgradeState.AddOrUpgradeWeapon(weaponId);
} else {
    weaponUpgradeManager.UpgradeWeapon(world, player, weaponId);
    upgradeState.AddOrUpgradeWeapon(weaponId);
}
```

### 2. PlayerContext.cs
**修改内容**:
- 添加了 `UpgradeState` 属性
- 添加了 `WeaponUpgradeManager` 属性
- 在 `Initialize()` 中创建 UpgradeState 实例

**新增代码**:
```csharp
public PlayerUpgradeState UpgradeState { get; private set; }
public WeaponUpgradeManager WeaponUpgradeManager { get; set; }
```

### 3. ECSGameManager.cs
**修改内容**:
- 添加了 `weaponUpgradeManager` 字段
- 在 `Bind()` 方法中初始化武器升级管理器
- 调用 `UpgradeApplyService.Initialize()`
- 添加配置加载（升级规则相关）
- 添加了 `TestWeaponUpgrade()` 测试方法

**关键代码**:
```csharp
weaponUpgradeManager = new WeaponUpgradeManager(
    WeaponUpgradeRuleConfigDB.Instance,
    WeaponConfigDB.Instance
);
PlayerContext.Instance.WeaponUpgradeManager = weaponUpgradeManager;
UpgradeApplyService.Initialize(weaponUpgradeManager);
```

### 4. UpgradeService.cs
**修改内容**:
- 添加了新的 `RollOptions()` 重载，自动从 PlayerContext 获取状态
- 在 `WeightedCandidate` 中添加了 `currentLevel` 字段
- 改进了 `BuildOption()` 方法，在描述中显示等级信息

## 🎯 系统特性

### 1. 配置驱动
- 完全基于 JSON 配置文件
- 支持多种升级规则（加法、乘法）
- 支持条件升级（每 N 级）

### 2. 属性管理
- 分离基础属性和升级修改
- 支持多种武器类型（投射物、环绕）
- 提供计算最终属性的便捷方法

### 3. 集成良好
- 与现有 ECS 系统无缝集成
- 与经验升级系统配合
- 支持 Lua 脚本调用

### 4. 可扩展性
- 易于添加新的升级属性
- 支持自定义升级规则
- 预留被动技能系统接口

## 📊 升级规则示例

```json
{
  "ProjectileKnife": {
    "maxLevel": 8,
    "rules": [
      { "stat": "Damage", "op": "Add", "value": 2 },           // 每级 +2 伤害
      { "stat": "Count", "op": "Add", "value": 1, "every": 2 }, // 每2级 +1 数量
      { "stat": "Cooldown", "op": "Mul", "value": 0.9, "every": 3 } // 每3级 x0.9 冷却
    ]
  }
}
```

## 🔧 使用方式

### 代码中使用
```csharp
var weaponMgr = PlayerContext.Instance.WeaponUpgradeManager;
weaponMgr.AddWeapon(world, player, "ProjectileKnife");
weaponMgr.UpgradeWeapon(world, player, "ProjectileKnife");
```

### 通过升级系统
```csharp
UpgradeApplyService.Apply(upgradeOption);
```

### Unity Editor 测试
右键 ECSGameManager → 测试武器升级

## ⚠️ 注意事项

1. **初始化顺序**: 必须先初始化 PlayerContext 才能使用武器升级管理器
2. **配置加载**: 确保所有相关配置文件已正确加载
3. **组件依赖**: 玩家实体必须有 WeaponSlotsComponent
4. **运行时属性**: 武器发射系统应从 WeaponRuntimeStatsComponent 读取属性

## 🚀 后续建议

1. **武器发射系统集成**: 修改 WeaponFireSystem 和 OrbitSystem 使用运行时属性
2. **UI 显示**: 创建武器详情界面显示等级和属性
3. **被动技能系统**: 实现类似的被动技能升级逻辑
4. **保存/加载**: 添加武器状态的持久化
5. **特效系统**: 升级时显示视觉效果

## ✅ 测试清单

- [x] 添加新武器
- [x] 升级现有武器
- [x] 达到最大等级限制
- [x] 属性正确累加
- [x] 规则条件判断（every）
- [ ] 与发射系统集成
- [ ] UI 显示
- [ ] 保存/加载

## 📝 相关文件列表

**新增**:
- `Assets/Scripts/Battle/WeaponUpgradeManager.cs`
- `Assets/Scripts/Game/ECS/WeaponRuntimeStatsComponent.cs`
- `Assets/Scripts/Battle/武器升级系统文档.md`

**修改**:
- `Assets/Scripts/Battle/UpgradeApplyService.cs`
- `Assets/Scripts/Battle/PlayerContext.cs`
- `Assets/Scripts/Battle/ECSGameManager.cs`
- `Assets/Scripts/Battle/UpgradeService.cs`

---

**修改日期**: 2026-01-14
**版本**: v1.0
**状态**: ✅ 完成
