# 武器升级系统使用文档

## 系统概述

武器升级系统提供了完整的武器管理和升级功能，包括：
- 添加新武器
- 升级现有武器
- 基于配置的属性修改
- 运行时属性管理

## 核心组件

### 1. WeaponUpgradeManager
武器升级的核心管理器，负责所有武器相关操作。

**主要方法：**
- `AddWeapon(World world, int playerEntity, string weaponId)` - 添加新武器
- `UpgradeWeapon(World world, int playerEntity, string weaponId)` - 升级武器
- `GetWeaponLevel(World world, int playerEntity, string weaponId)` - 获取武器等级
- `GetWeaponMaxLevel(string weaponId)` - 获取武器最大等级
- `CanUpgradeWeapon(World world, int playerEntity, string weaponId)` - 检查是否可升级
- `TryGetWeaponStats(...)` - 获取武器运行时属性

### 2. WeaponRuntimeStatsComponent
存储每个武器的运行时属性，包括基础属性和升级累积的修改。

**属性类别：**
- 基础属性：damage, projectileCount, knockback
- 投射物专属：fireRate, projectileSpeed, projectileRange
- 环绕武器专属：orbitRadius, orbitSpeed, orbitCount
- 升级修改：damageAdd, damageMultiply, countAdd, fireRateMultiply, radiusAdd

### 3. UpgradeApplyService
负责应用升级选项的服务类。

**使用：**
```csharp
// 初始化（在 ECSGameManager.Bind 中完成）
UpgradeApplyService.Initialize(weaponUpgradeManager);

// 应用升级选项
UpgradeApplyService.Apply(upgradeOption);
```

### 4. PlayerUpgradeState
跟踪玩家拥有的武器和被动技能等级。

## 配置文件

### weapon_upgrade_rule_config.json
定义每个武器的升级规则。

**示例：**
```json
{
  "weapons": {
    "ProjectileKnife": {
      "maxLevel": 8,
      "rules": [
        { "stat": "Damage", "op": "Add", "value": 2 },
        { "stat": "Count", "op": "Add", "value": 1, "every": 2 },
        { "stat": "Cooldown", "op": "Mul", "value": 0.9, "every": 3 }
      ]
    }
  }
}
```

**规则说明：**
- `stat`: 属性名称 (Damage, Count, Cooldown, Radius)
- `op`: 操作类型 (Add=加法, Mul=乘法)
- `value`: 修改值
- `every`: 每隔多少级应用（可选，0或不设置表示每级都应用）

## 使用示例

### 1. 在代码中手动添加/升级武器

```csharp
// 获取管理器
var weaponMgr = PlayerContext.Instance.WeaponUpgradeManager;
var world = PlayerContext.Instance.World;
var player = PlayerContext.Instance.PlayerEntity;

// 添加新武器
weaponMgr.AddWeapon(world, player, "ProjectileKnife");

// 升级武器
weaponMgr.UpgradeWeapon(world, player, "ProjectileKnife");

// 检查武器等级
int level = weaponMgr.GetWeaponLevel(world, player, "ProjectileKnife");
Debug.Log($"武器等级: {level}");

// 获取武器运行时属性
if (weaponMgr.TryGetWeaponStats(world, player, "ProjectileKnife", out var stats))
{
    Debug.Log($"伤害: {stats.GetFinalDamage()}");
    Debug.Log($"数量: {stats.GetFinalProjectileCount()}");
}
```

### 2. 通过升级选项系统

```csharp
// 玩家升级时获取选项
var upgradeService = new UpgradeService(...);
var options = upgradeService.RollOptions(3, playerLevel);

// 玩家选择一个选项后应用
UpgradeApplyService.Apply(selectedOption);
```

### 3. Unity Inspector 测试

在 ECSGameManager 上右键选择 "测试武器升级" 来测试升级功能。

## 武器发射系统集成

武器发射系统应该从 WeaponRuntimeStatsComponent 读取属性，而不是直接使用配置：

```csharp
// 在 WeaponFireSystem 中
if (world.TryGetComponent<WeaponRuntimeStatsComponent>(entity, out var runtimeStats))
{
    if (runtimeStats.TryGetStats(weaponId, out var stats))
    {
        // 使用运行时属性
        float damage = stats.GetFinalDamage();
        int count = stats.GetFinalProjectileCount();
        float fireRate = stats.GetFinalFireRate();
        
        // ... 发射逻辑
    }
}
```

## 扩展建议

1. **添加新的升级属性**
   - 在 StatUpgradeRule 中添加新的 stat 类型
   - 在 WeaponRuntimeStatsComponent.WeaponStats 中添加对应字段
   - 在 WeaponUpgradeManager.ApplySingleRule 中处理新属性

2. **实现被动技能系统**
   - 创建 PassiveUpgradeManager
   - 实现类似的属性修改逻辑
   - 在 UpgradeApplyService.ApplyPassive 中集成

3. **UI 集成**
   - 显示武器等级和属性
   - 显示升级预览
   - 添加升级动画效果

## 调试

启用调试日志查看详细的升级过程：
- 武器添加
- 等级变化
- 属性修改
- 规则应用

所有关键操作都会输出到 Unity Console。
